#
# Infrastructure Configuration Registry
# Single Source of Truth for all deployment configurations
#
# This file defines all ports, paths, resources, and connection strings
# used across Docker Compose, Kubernetes, and other deployment targets.
#

# Application metadata
metadata:
  name: srvthreds
  namespace: srvthreds
  version: "1.0.0"

# Service definitions
services:
  builder:
    name: srvthreds-builder
    description: Base builder image with compiled artifacts
    image:
      repository: srvthreds/builder
      tag: latest
    buildOnly: true  # This service is only for building, not running
    dockerfile: infrastructure/local/docker/dockerfiles/Dockerfile.builder

  bootstrap:
    name: srvthreds-bootstrap
    description: Database initialization and seeding
    image:
      repository: srvthreds/bootstrap
      tag: latest
    dockerfile: infrastructure/local/docker/dockerfiles/Dockerfile.cmdRunner
    command:
      entrypoint: npm
      args:
        - run
        - bootstrap
        - --
        - -p
        - ef-detection
    ports: {}
    environment:
      NODE_ENV: development
      MONGO_HOST: ${MONGO_HOST:-mongo-repl-1:27017}
      REDIS_HOST: ${REDIS_HOST:-redis:6379}
      RABBITMQ_HOST: ${RABBITMQ_HOST:-rabbitmq}
    restartPolicy: "no"  # Run once and exit

  engine:
    name: srvthreds-engine
    description: Main event processing engine
    image:
      repository: srvthreds/engine
      tag: latest
    dockerfile: infrastructure/local/docker/dockerfiles/Dockerfile
    command:
      entrypoint: node
      args:
        - dist-server/index.js
        - -d
    ports:
      http: 8082
    environment:
      NODE_ENV: development
      MONGO_HOST: ${MONGO_HOST:-mongo-repl-1:27017}
      REDIS_HOST: ${REDIS_HOST:-redis:6379}
      RABBITMQ_HOST: ${RABBITMQ_HOST:-rabbitmq}
    dependsOn:
      - srvthreds-bootstrap
    resources:
      memory:
        request: 256Mi
        limit: 512Mi
      cpu:
        request: 200m
        limit: 500m
    replicas:
      dev: 1
      staging: 2
      production: 3

  session-agent:
    name: srvthreds-session-agent
    description: Manages user sessions and participant interactions
    image:
      repository: srvthreds/session-agent
      tag: latest
    dockerfile: infrastructure/local/docker/dockerfiles/Dockerfile
    command:
      entrypoint: node
      args:
        - dist-server/agent/agent.js
        - -c
        - session_agent
        - -i
        - org.wt.session1
        - -d
    ports:
      http: 3000
      websocket: 3001
    environment:
      NODE_ENV: development
      MONGO_HOST: ${MONGO_HOST:-mongo-repl-1:27017}
      REDIS_HOST: ${REDIS_HOST:-redis:6379}
      RABBITMQ_HOST: ${RABBITMQ_HOST:-rabbitmq}
    dependsOn:
      - srvthreds-bootstrap
    resources:
      memory:
        request: 128Mi
        limit: 256Mi
      cpu:
        request: 100m
        limit: 300m
    replicas:
      dev: 1
      staging: 2
      production: 3

  persistence-agent:
    name: srvthreds-persistence-agent
    description: Handles data persistence operations
    image:
      repository: srvthreds/persistence-agent
      tag: latest
    dockerfile: infrastructure/local/docker/dockerfiles/Dockerfile
    command:
      entrypoint: node
      args:
        - dist-server/agent/agent.js
        - -c
        - persistence_agent
        - -i
        - org.wt.persistence1
        - -d
    ports: {}
    environment:
      NODE_ENV: development
      MONGO_HOST: ${MONGO_HOST:-mongo-repl-1:27017}
      REDIS_HOST: ${REDIS_HOST:-redis:6379}
      RABBITMQ_HOST: ${RABBITMQ_HOST:-rabbitmq}
    dependsOn:
      - srvthreds-bootstrap
    resources:
      memory:
        request: 256Mi
        limit: 512Mi
      cpu:
        request: 200m
        limit: 400m
    replicas:
      dev: 1
      staging: 2
      production: 3

# Database definitions
databases:
  mongodb:
    name: mongo-repl-1
    description: MongoDB replica set primary node
    image:
      repository: mongo
      tag: latest
    port: 27017
    command:
      - mongod
      - --replSet
      - rs0
      - --bind_ip_all
    environment:
      MONGO_INITDB_DATABASE: admin
    volumes:
      mountPath: /data/db
      hostPath: ./.docker/mongodb/data/db
    healthcheck:
      test: echo 'db.runCommand("ping").ok' | mongosh localhost:27017/admin --quiet
      interval: 10s
      timeout: 10s
      retries: 5
      startPeriod: 30s
    resources:
      memory:
        request: 512Mi
        limit: 1Gi
      cpu:
        request: 250m
        limit: 500m

  redis:
    name: redis
    description: Redis cache server
    image:
      repository: redis
      tag: latest
    port: 6379
    command:
      - redis-server
      - --save
      - "20"
      - "1"
      - --loglevel
      - warning
      - --notify-keyspace-events
      - KA
    volumes:
      mountPath: /data
      hostPath: ./.docker/redis-data
    resources:
      memory:
        request: 128Mi
        limit: 256Mi
      cpu:
        request: 100m
        limit: 200m

  rabbitmq:
    name: rabbitmq
    description: RabbitMQ message broker
    image:
      repository: rabbitmq
      tag: 3-management
    ports:
      amqp: 5672
      management: 15672
    volumes:
      - mountPath: /var/lib/rabbitmq
        hostPath: ./.docker/rabbitmq/data
      - mountPath: /var/log/rabbitmq
        hostPath: ./.docker/rabbitmq/logs
    resources:
      memory:
        request: 256Mi
        limit: 512Mi
      cpu:
        request: 150m
        limit: 300m

# Build paths and contexts
build:
  context: /app
  distPath: /app/dist-server
  workdir: /app
  assets:
    source: infrastructure/tools/deployment-cli/assets
    destination: /app/dist-server
  dockerfiles:
    builder: infrastructure/local/docker/dockerfiles/Dockerfile.builder
    runtime: infrastructure/local/docker/dockerfiles/Dockerfile
    cmdRunner: infrastructure/local/docker/dockerfiles/Dockerfile.cmdRunner
  dockerContext:
    root: ../../../../
    thredlib: ../../../../../thredlib

# Network configuration
networks:
  default:
    name: srvthreds-net
    driver: bridge

# Environment-specific connection strings
# These are templates that get populated based on the deployment target
connectionStrings:
  # Local development (host machine connecting to Docker containers)
  local:
    mongodb: "localhost:27017"
    redis: "localhost:6379"
    rabbitmq: "localhost"
    mongoDirectConnection: true

  # Docker Compose (all services in containers)
  docker:
    mongodb: "mongo-repl-1:27017"
    redis: "redis:6379"
    rabbitmq: "rabbitmq"
    mongoDirectConnection: true

  # Kubernetes/Minikube (services via k8s DNS)
  kubernetes:
    mongodb: "mongodb-service:27017"
    redis: "redis-service:6379"
    rabbitmq: "rabbitmq-service"
    mongoDirectConnection: false

  # Minikube (host.minikube.internal for services outside k8s)
  minikube:
    mongodb: "host.minikube.internal:27017"
    redis: "host.minikube.internal:6379"
    rabbitmq: "host.minikube.internal"
    mongoDirectConnection: true

# JWT/Security configuration (non-sensitive defaults)
security:
  jwt:
    expireTime: 1h
    refreshTokenExpireTime: 7d
