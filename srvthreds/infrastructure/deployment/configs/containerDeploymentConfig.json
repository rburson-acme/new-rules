{
  "deployments": [
    {
      "name": "Start Databases",
      "shortName": "s_a_dbs",
      "description": "Starts the database containers (Mongo, Redis, RabbitMQ).",
      "environments": [
        "local",
        "minikube",
        "dev",
        "test"
      ],
      "target": {
        "type": "docker-compose",
        "composing": "databases",
        "deployCommand": "up",
        "composeFile": "docker-compose-db.yml",
        "defaultArgs": "-d --wait",
        "environmentOverrides": {
          "local": {
            "postUpCommands": [
              {
                "description": "Setting up MongoDB replica set...",
                "command": "infrastructure/local/scripts/setup-repl.sh"
              }
            ]
          }
        }
      }
    },
    {
      "name": "Stop Databases",
      "shortName": "d_a_dbs",
      "description": "Stops and removes the database containers and their volumes.",
      "environments": [
        "local",
        "dev",
        "test"
      ],
      "target": {
        "composing": "databases",
        "deployCommand": "down",
        "composeFile": "docker-compose-db.yml",
        "defaultArgs": "-v"
      }
    },
    {
      "name": "Start Services",
      "shortName": "s_a_s",
      "description": "Starts the application services.",
      "environments": [
        "local",
        "dev",
        "staging"
      ],
      "target": {
        "composing": "services",
        "deployCommand": "up",
        "composeFile": "docker-compose-services.yml",
        "defaultArgs": "-d --wait",
        "preBuildCommands": [
          {
            "description": "Building base builder image (uses cache if available)...",
            "command": "docker compose -f infrastructure/local/compose/docker-compose-services.yml build srvthreds-builder"
          }
        ],
        "environmentOverrides": {
          "local": {
            "preBuildCommands": [
              {
                "description": "Copy environment config into assets folder for delivery.",
                "command": "cp ./infrastructure/local/configs/.env.local.example ./infrastructure/deployment/assets/.env"
              },
              {
                "description": "Log out assets pushed to deployment assets folder",
                "command": "echo '--- Local Assets Copied ---' && ls -aF ./infrastructure/deployment/assets/ && cat ./infrastructure/deployment/assets/.env"
              },
              {
                "description": "Building production-optimized builder image...",
                "command": "docker compose -f infrastructure/local/compose/docker-compose-services.yml build --progress=plain --no-cache srvthreds-builder"
              }
            ],
            "postUpCommands": [
              {
                "description": "Cleanup deployment assets directory",
                "command": "find infrastructure/deployment/assets/ -mindepth 1 -delete"
              }
            ]
          }
        }
      }
    },
    {
      "name": "Stop Services",
      "shortName": "d_a_s",
      "description": "Stops and removes the application services.",
      "environments": [
        "local",
        "dev"
      ],
      "target": {
        "composing": "services",
        "deployCommand": "down",
        "composeFile": "docker-compose-services.yml",
        "defaultArgs": "-v --rmi local"
      }
    },
    {
      "name": "Start All",
      "shortName": "s_a_dbs_s",
      "description": "Starts all databases and application services.",
      "environments": [
        "local"
      ],
      "target": {
        "composing": "all",
        "deployCommand": "up",
        "composeFiles": [
          {
            "composeFile": "docker-compose-db.yml",
            "defaultArgs": "-d --wait",
            "postUpCommands": [
              {
                "description": "Setting up MongoDB replica set...",
                "command": "chmod +x ./infrastructure/local/scripts/setup-repl.sh && ./infrastructure/local/scripts/setup-repl.sh"
              }
            ]
          },
          {
            "composeFile": "docker-compose-services.yml",
            "defaultArgs": "-d --wait",
            "preBuildCommands": [
              {
                "description": "Building base builder image (uses cache if available)...",
                "command": "docker compose -f infrastructure/local/compose/docker-compose-services.yml build --progress=plain --no-cache srvthreds-builder"
              }
            ],
            "environmentOverrides": {
              "local": {
                "preBuildCommands": [
                  {
                    "description": "Copy environment config into assets folder for delivery.",
                    "command": "cp ./infrastructure/local/configs/.env.local.example ./infrastructure/deployment/assets/.env"
                  },
                  {
                    "description": "Log out assets pushed to deployment assets folder",
                    "command": "echo '--- Local Assets Copied ---' && ls -aF ./infrastructure/deployment/assets/ && cat ./infrastructure/deployment/assets/.env"
                  },
                  {
                    "description": "Building production-optimized builder image...",
                    "command": "docker compose -f infrastructure/local/compose/docker-compose-services.yml build --progress=plain --no-cache srvthreds-builder"
                  }
                ],
                "postUpCommands": [
                  {
                    "description": "Cleanup deployment assets directory",
                    "command": "find infrastructure/deployment/assets/ -mindepth 1 -delete"
                  }
                ]
              }
            }
          }
        ]
      }
    },
    {
      "name": "Stop All",
      "shortName": "d_a_dbs_s",
      "description": "Stops all databases and application services.",
      "environments": [
        "local"
      ],
      "target": {
        "composing": "all",
        "deployCommand": "down",
        "composeFiles": [
          {
            "composeFile": "docker-compose-db.yml",
            "defaultArgs": "-v"
          },
          {
            "composeFile": "docker-compose-services.yml",
            "defaultArgs": "-v --rmi local"
          }
        ]
      }
    },
    {
      "name": "Start Server",
      "shortName": "s_s",
      "description": "Starts the application server service.",
      "environments": [
        "local",
        "dev"
      ],
      "target": {
        "composing": "service",
        "deployCommand": "up",
        "composeFile": "docker-compose-services.yml",
        "defaultArgs": "srvthreds-engine -d --wait",
        "environmentOverrides": {
          "local": {
            "preBuildCommands": [
              {
                "description": "Copy environment config into assets folder for delivery.",
                "command": "cp ./infrastructure/local/configs/.env.local.example ./infrastructure/deployment/assets/.env"
              },
              {
                "description": "Building production-optimized builder image...",
                "command": "docker compose -f infrastructure/local/compose/docker-compose-services.yml build --no-cache srvthreds-builder"
              }
            ],
            "postUpCommands": [
              {
                "description": "Cleanup deployment assets directory",
                "command": "find infrastructure/deployment/assets/ -mindepth 1 -delete"
              }
            ]
          }
        }
      }
    },
    {
      "name": "Stop Server",
      "shortName": "d_s",
      "description": "Stops and removes the application server services.",
      "environments": [
        "local",
        "dev"
      ],
      "target": {
        "composing": "service",
        "deployCommand": "down",
        "composeFile": "docker-compose-services.yml",
        "defaultArgs": "srvthreds-engine -v --rmi local"
      }
    },
    {
      "name": "Start Session Agent Service",
      "shortName": "s_sa",
      "description": "Starts the application session agent service.",
      "environments": [
        "local",
        "dev"
      ],
      "target": {
        "composing": "service",
        "deployCommand": "up",
        "composeFile": "docker-compose-services.yml",
        "defaultArgs": "srvthreds-session-agent -d --wait",
        "environmentOverrides": {
          "local": {
            "preBuildCommands": [
              {
                "description": "Copy environment config into assets folder for delivery.",
                "command": "cp ./infrastructure/local/configs/.env.local.example ./infrastructure/deployment/assets/.env"
              },
              {
                "description": "Building production-optimized builder image...",
                "command": "docker compose -f infrastructure/local/compose/docker-compose-services.yml build --no-cache srvthreds-builder"
              }
            ],
            "postUpCommands": [
              {
                "description": "Cleanup deployment assets directory",
                "command": "find infrastructure/deployment/assets/ -mindepth 1 -delete"
              }
            ]
          }
        }
      }
    },
    {
      "name": "Stop Session Agent Services",
      "shortName": "d_sa",
      "description": "Stops and removes the application session agent service.",
      "environments": [
        "local",
        "dev"
      ],
      "target": {
        "composing": "service",
        "deployCommand": "down",
        "composeFile": "docker-compose-services.yml",
        "defaultArgs": "srvthreds-session-agent -v --rmi local"
      }
    },
    {
      "name": "Start Persistence Agent Service",
      "shortName": "s_pa",
      "description": "Starts the application persistence agent service.",
      "environments": [
        "local",
        "dev"
      ],
      "target": {
        "composing": "service",
        "deployCommand": "up",
        "composeFile": "docker-compose-services.yml",
        "defaultArgs": "srvthreds-persistence-agent -d --wait",
        "environmentOverrides": {
          "local": {
            "preBuildCommands": [
              {
                "description": "Copy environment config into assets folder for delivery.",
                "command": "cp ./infrastructure/local/configs/.env.local.example ./infrastructure/deployment/assets/.env"
              },
              {
                "description": "Building production-optimized builder image...",
                "command": "docker compose -f infrastructure/local/compose/docker-compose-services.yml build --no-cache srvthreds-builder"
              }
            ],
            "postUpCommands": [
              {
                "description": "Cleanup deployment assets directory",
                "command": "find infrastructure/deployment/assets/ -mindepth 1 -delete"
              }
            ]
          }
        }
      }
    },
    {
      "name": "Stop Persistence Agent Service",
      "shortName": "d_pa",
      "description": "Stops the application persistence agent service.",
      "environments": [
        "local",
        "dev"
      ],
      "target": {
        "composing": "service",
        "deployCommand": "down",
        "composeFile": "docker-compose-services.yml",
        "defaultArgs": "srvthreds-persistence-agent -v --rmi local"
      }
    },
    {
      "name": "Run bootstrap for data",
      "shortName": "bootstrap",
      "description": "Bootstrap the database with configuration data.",
      "environments": [
        "local",
        "dev"
      ],
      "target": {
        "composing": "service",
        "deployCommand": "up",
        "composeFile": "docker-compose-services.yml",
        "defaultArgs": "srvthreds-bootstrap -d --wait"
      }
    },
    {
      "name": "Create Base Image",
      "shortName": "build_server",
      "description": "Creates the base image used by all services.",
      "environments": [
        "local",
        "minikube"
      ],
      "target": {
        "composing": "service",
        "deployCommand": "build",
        "composeFile": "docker-compose-services.yml",
        "defaultArgs": "--progress=plain srvthreds-builder",
        "environmentOverrides": {
          "local": {
            "preBuildCommands": [
              {
                "description": "Copy environment config into assets folder for delivery.",
                "command": "cp ./infrastructure/local/configs/.env.local.example ./infrastructure/deployment/assets/.env"
              }
            ],
            "postUpCommands": [
              {
                "description": "Cleanup deployment assets directory",
                "command": "find infrastructure/deployment/assets/ -mindepth 1 -delete"
              }
            ]
          },
          "minikube": {
            "preBuildCommands": [
              {
                "description": "Create empty .env placeholder (Kubernetes uses ConfigMap instead)",
                "command": "touch ./infrastructure/deployment/assets/.env"
              }
            ],
            "postUpCommands": [
              {
                "description": "Cleanup deployment assets directory",
                "command": "find infrastructure/deployment/assets/ -mindepth 1 -delete"
              }
            ]
          }
        }
      }
    },
    {
      "name": "Deploy to Minikube",
      "shortName": "k8s_minikube",
      "description": "Deploy services to Minikube Kubernetes cluster",
      "environments": [
        "minikube"
      ],
      "target": {
        "type": "sh",
        "composing": "kubernetes",
        "deployCommand": "infrastructure/kubernetes/scripts/setup-minikube.sh"
      }
    },
    {
      "name": "Apply Kubernetes Manifests to Minikube",
      "shortName": "k8s_apply",
      "description": "Apply Kubernetes manifests using kubectl (Minikube must be running)",
      "environments": [
        "minikube"
      ],
      "target": {
        "type": "kubectl",
        "composing": "kubernetes",
        "deployCommand": "apply",
        "defaultArgs": "-k infrastructure/kubernetes/overlays/minikube/",
        "preBuildCommands": [
          {
            "description": "Switching kubectl context to Minikube...",
            "command": "infrastructure/kubernetes/scripts/switch-to-minikube.sh"
          }
        ]
      }
    },
    {
      "name": "Set Kubernetes Context to Minikube",
      "shortName": "set_context",
      "description": "Set Kubernetes Context to Minikube",
      "environments": [
        "minikube"
      ],
      "target": {
        "type": "sh",
        "composing": "kubernetes",
         "deployCommand": "infrastructure/kubernetes/scripts/switch-to-minikube.sh"
      }
    },
    {
      "name": "Reset Minikube Deployment",
      "shortName": "k8s_reset",
      "description": "Reset Minikube deployment (deletes namespace, keeps cluster running)",
      "environments": [
        "minikube"
      ],
      "target": {
        "type": "sh",
        "composing": "kubernetes",
        "deployCommand": "infrastructure/kubernetes/scripts/reset-minikube.sh"
      }
    },
    {
      "name": "Full Cleanup Minikube",
      "shortName": "k8s_cleanup",
      "description": "Complete cleanup: deletes cluster, resources, and optionally databases",
      "environments": [
        "minikube"
      ],
      "target": {
        "type": "sh",
        "composing": "kubernetes",
        "deployCommand": "infrastructure/kubernetes/scripts/cleanup-minikube.sh"
      }
    }
  ]
}