{
  "deployments": [
    {
      "name": "Start Services",
      "shortName": "s_a_s",
      "description": "Starts the application services.",
      "environments": [
        "local",
        "dev",
        "staging"
      ],
      "target": {
        "composing": "services",
        "deployCommand": "up",
        "composeFile": "docker-compose-services.yml",
        "defaultArgs": "-d --wait",
        "preBuildCommands": [
          {
            "description": "Generating service configurations from config-registry.yaml...",
            "command": "tsx infrastructure/tools/config-generator/index.ts docker-compose agent-configs"
          },
          {
            "description": "Validating configuration consistency...",
            "command": "tsx infrastructure/tools/config-validator/index.ts"
          },
          {
            "description": "Building base builder image (uses cache if available)...",
            "command": "docker compose -f infrastructure/local/docker/compose/docker-compose-services.yml build srvthreds-builder"
          }
        ],
        "environmentOverrides": {
          "local": {
            "preBuildCommands": [
              {
                "description": "Copy Docker environment config into assets folder for delivery.",
                "command": "cp ./infrastructure/local/configs/.env.docker ./infrastructure/tools/deployment-cli/assets/.env"
              },
              {
                "description": "Log out assets pushed to deployment assets folder",
                "command": "echo '--- Docker Assets Copied ---' && ls -aF ./infrastructure/tools/deployment-cli/assets/ && cat ./infrastructure/tools/deployment-cli/assets/.env"
              },
              {
                "description": "Building production-optimized builder image...",
                "command": "docker compose -f infrastructure/local/docker/compose/docker-compose-services.yml build --progress=plain --no-cache srvthreds-builder"
              }
            ],
            "postUpCommands": [
              {
                "description": "Cleanup deployment assets directory",
                "command": "find infrastructure/tools/deployment-cli/assets/ -mindepth 1 -delete"
              }
            ]
          }
        }
      }
    },
    {
      "name": "Stop Services",
      "shortName": "d_a_s",
      "description": "Stops and removes the application services.",
      "environments": [
        "local",
        "dev"
      ],
      "target": {
        "composing": "services",
        "deployCommand": "down",
        "composeFile": "docker-compose-services.yml",
        "defaultArgs": "-v --rmi local"
      }
    },
    {
      "name": "Start All",
      "shortName": "s_a_dbs_s",
      "description": "Starts all databases and application services.",
      "environments": [
        "local"
      ],
      "target": {
        "composing": "all",
        "deployCommand": "up",
        "composeFiles": [
          {
            "composeFile": "docker-compose-db.yml",
            "defaultArgs": "-d --wait",
            "preBuildCommands": [
              {
                "description": "Generating all configurations from config-registry.yaml...",
                "command": "tsx infrastructure/tools/config-generator/index.ts"
              },
              {
                "description": "Validating configuration consistency...",
                "command": "tsx infrastructure/tools/config-validator/index.ts"
              }
            ],
            "postUpCommands": [
              {
                "description": "Setting up MongoDB replica set...",
                "command": "chmod +x ./infrastructure/local/docker/scripts/setup-repl.sh && ./infrastructure/local/docker/scripts/setup-repl.sh"
              }
            ]
          },
          {
            "composeFile": "docker-compose-services.yml",
            "defaultArgs": "-d --wait",
            "preBuildCommands": [
              {
                "description": "Building base builder image (uses cache if available)...",
                "command": "docker compose -f infrastructure/local/docker/compose/docker-compose-services.yml build --progress=plain --no-cache srvthreds-builder"
              }
            ],
            "environmentOverrides": {
              "local": {
                "preBuildCommands": [
                  {
                    "description": "Copy Docker environment config into assets folder for delivery.",
                    "command": "cp ./infrastructure/local/configs/.env.docker ./infrastructure/tools/deployment-cli/assets/.env"
                  },
                  {
                    "description": "Log out assets pushed to deployment assets folder",
                    "command": "echo '--- Docker Assets Copied ---' && ls -aF ./infrastructure/tools/deployment-cli/assets/ && cat ./infrastructure/tools/deployment-cli/assets/.env"
                  },
                  {
                    "description": "Building production-optimized builder image...",
                    "command": "docker compose -f infrastructure/local/docker/compose/docker-compose-services.yml build --progress=plain --no-cache srvthreds-builder"
                  }
                ],
                "postUpCommands": [
                  {
                    "description": "Cleanup deployment assets directory",
                    "command": "find infrastructure/tools/deployment-cli/assets/ -mindepth 1 -delete"
                  }
                ]
              }
            }
          }
        ]
      }
    },
    {
      "name": "Stop All",
      "shortName": "d_a_dbs_s",
      "description": "Stops all databases and application services.",
      "environments": [
        "local"
      ],
      "target": {
        "composing": "all",
        "deployCommand": "down",
        "composeFiles": [
          {
            "composeFile": "docker-compose-db.yml",
            "defaultArgs": "-v"
          },
          {
            "composeFile": "docker-compose-services.yml",
            "defaultArgs": "-v --rmi local"
          }
        ]
      }
    },
    {
      "name": "Start Server",
      "shortName": "s_s",
      "description": "Starts the application server service.",
      "environments": [
        "local",
        "dev"
      ],
      "target": {
        "composing": "service",
        "deployCommand": "up",
        "composeFile": "docker-compose-services.yml",
        "defaultArgs": "srvthreds-engine -d --wait",
        "environmentOverrides": {
          "local": {
            "preBuildCommands": [
              {
                "description": "Copy environment config into assets folder for delivery.",
                "command": "cp ./infrastructure/local/configs/.env.local.example ./infrastructure/tools/deployment-cli/assets/.env"
              },
              {
                "description": "Building production-optimized builder image...",
                "command": "docker compose -f infrastructure/local/docker/compose/docker-compose-services.yml build --no-cache srvthreds-builder"
              }
            ],
            "postUpCommands": [
              {
                "description": "Cleanup deployment assets directory",
                "command": "find infrastructure/tools/deployment-cli/assets/ -mindepth 1 -delete"
              }
            ]
          }
        }
      }
    },
    {
      "name": "Stop Server",
      "shortName": "d_s",
      "description": "Stops and removes the application server services.",
      "environments": [
        "local",
        "dev"
      ],
      "target": {
        "composing": "service",
        "deployCommand": "down",
        "composeFile": "docker-compose-services.yml",
        "defaultArgs": "srvthreds-engine -v --rmi local"
      }
    },
    {
      "name": "Start Session Agent Service",
      "shortName": "s_sa",
      "description": "Starts the application session agent service.",
      "environments": [
        "local",
        "dev"
      ],
      "target": {
        "composing": "service",
        "deployCommand": "up",
        "composeFile": "docker-compose-services.yml",
        "defaultArgs": "srvthreds-session-agent -d --wait",
        "environmentOverrides": {
          "local": {
            "preBuildCommands": [
              {
                "description": "Copy environment config into assets folder for delivery.",
                "command": "cp ./infrastructure/local/configs/.env.local.example ./infrastructure/tools/deployment-cli/assets/.env"
              },
              {
                "description": "Building production-optimized builder image...",
                "command": "docker compose -f infrastructure/local/docker/compose/docker-compose-services.yml build --no-cache srvthreds-builder"
              }
            ],
            "postUpCommands": [
              {
                "description": "Cleanup deployment assets directory",
                "command": "find infrastructure/tools/deployment-cli/assets/ -mindepth 1 -delete"
              }
            ]
          }
        }
      }
    },
    {
      "name": "Stop Session Agent Services",
      "shortName": "d_sa",
      "description": "Stops and removes the application session agent service.",
      "environments": [
        "local",
        "dev"
      ],
      "target": {
        "composing": "service",
        "deployCommand": "down",
        "composeFile": "docker-compose-services.yml",
        "defaultArgs": "srvthreds-session-agent -v --rmi local"
      }
    },
    {
      "name": "Start Persistence Agent Service",
      "shortName": "s_pa",
      "description": "Starts the application persistence agent service.",
      "environments": [
        "local",
        "dev"
      ],
      "target": {
        "composing": "service",
        "deployCommand": "up",
        "composeFile": "docker-compose-services.yml",
        "defaultArgs": "srvthreds-persistence-agent -d --wait",
        "environmentOverrides": {
          "local": {
            "preBuildCommands": [
              {
                "description": "Copy environment config into assets folder for delivery.",
                "command": "cp ./infrastructure/local/configs/.env.local.example ./infrastructure/tools/deployment-cli/assets/.env"
              },
              {
                "description": "Building production-optimized builder image...",
                "command": "docker compose -f infrastructure/local/docker/compose/docker-compose-services.yml build --no-cache srvthreds-builder"
              }
            ],
            "postUpCommands": [
              {
                "description": "Cleanup deployment assets directory",
                "command": "find infrastructure/tools/deployment-cli/assets/ -mindepth 1 -delete"
              }
            ]
          }
        }
      }
    },
    {
      "name": "Stop Persistence Agent Service",
      "shortName": "d_pa",
      "description": "Stops the application persistence agent service.",
      "environments": [
        "local",
        "dev"
      ],
      "target": {
        "composing": "service",
        "deployCommand": "down",
        "composeFile": "docker-compose-services.yml",
        "defaultArgs": "srvthreds-persistence-agent -v --rmi local"
      }
    },
    {
      "name": "Run bootstrap for data",
      "shortName": "bootstrap",
      "description": "Bootstrap the database with configuration data.",
      "environments": [
        "local",
        "dev"
      ],
      "target": {
        "composing": "service",
        "deployCommand": "up",
        "composeFile": "docker-compose-services.yml",
        "defaultArgs": "srvthreds-bootstrap -d --wait"
      }
    }
  ]
}
