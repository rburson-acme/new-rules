# Project Configuration: srvthreds (v2 - Simplified)
# Event-driven workflow automation backend
#
# This is the single source of truth for deployment configuration.
# Run `npm run generate -p srvthreds` to generate docker-compose.generated.yaml

name: srvthreds
description: Event-driven workflow automation backend

source:
  # Path to source code relative to this project directory
  path: ../../../srvthreds

# Images to build
# These are referenced by services below
images:
  builder:
    dockerfile: docker/dockerfiles/Dockerfile.builder
    additionalContexts:
      thredlib: ../../../thredlib
      devops-assets: docker/assets

  app:
    dockerfile: docker/dockerfiles/Dockerfile
    additionalContexts:
      thredlib: ../../../thredlib
    args:
      BUILDER_IMAGE: srvthreds/builder:latest
    dependsOn: builder

  cmd-runner:
    dockerfile: docker/dockerfiles/Dockerfile.cmdRunner
    additionalContexts:
      thredlib: ../../../thredlib
    args:
      BUILDER_IMAGE: srvthreds/builder:latest
    dependsOn: builder

# Services configuration
services:
  # ============================================
  # Infrastructure services (minikube only)
  # ============================================
  mongo-repl-1:
    image: mongo:latest
    profiles: [infra]
    deploy: [minikube]
    containerName: mongo-repl-1
    restart: unless-stopped
    networks: [srvthreds-net]
    command:
      - mongod
      - '--replSet'
      - rs0
      - '--bind_ip_all'
    environment:
      MONGO_INITDB_DATABASE: admin
    ports:
      - '27017:27017'
    volumes:
      - ./.docker/mongodb/data/db:/data/db
    healthcheck:
      test: ["CMD", "mongosh", "localhost:27017/admin", "--quiet", "--eval", "db.runCommand('ping').ok"]
      interval: 10s
      timeout: 10s
      retries: 5
      startPeriod: 30s

  redis:
    image: redis:latest
    profiles: [infra]
    deploy: [minikube]
    containerName: redis
    restart: unless-stopped
    networks: [srvthreds-net]
    command:
      - redis-server
      - '--port'
      - '6379'
      - '--save'
      - '20'
      - '1'
      - '--loglevel'
      - warning
      - '--notify-keyspace-events'
      - KA
    ports:
      - '6379:6379'
    volumes:
      - ./.docker/redis-data:/data

  # RabbitMQ is deployed via K8s manifest (not Docker Compose)
  # - In dev/minikube: K8s pod (cost savings)
  # - In test/prod: managed service

  # ============================================
  # Build service (manual profile - builds only)
  # ============================================
  srvthreds-builder:
    image: builder
    profiles: [build]
    deploy: [minikube]

  # ============================================
  # Bootstrap service (runs once to initialize)
  # ============================================
  srvthreds-bootstrap:
    image: cmd-runner
    profiles: [app]
    deploy: [minikube]
    containerName: srvthreds-bootstrap
    restart: 'no'
    networks: [srvthreds-net]
    entrypoint: [npm]
    command: [run, bootstrap, '--', '-p', ef-detection]
    environment:
      NODE_ENV: development
      MONGO_HOST: ${MONGO_HOST:-mongo-repl-1:27017}
      REDIS_HOST: ${REDIS_HOST:-redis:6379}
      RABBITMQ_HOST: ${RABBITMQ_HOST:-rabbitmq}

  # ============================================
  # Application services
  # ============================================
  srvthreds-engine:
    image: app
    profiles: [app]
    deploy: [minikube, dev, test, prod]
    containerName: srvthreds-engine
    restart: unless-stopped
    networks: [srvthreds-net]
    entrypoint: [node]
    command: [dist-server/src/ts/index.js, '-d']
    environment:
      NODE_ENV: development
      MONGO_HOST: ${MONGO_HOST:-mongo-repl-1:27017}
      REDIS_HOST: ${REDIS_HOST:-redis:6379}
      RABBITMQ_HOST: ${RABBITMQ_HOST:-rabbitmq}
    ports:
      - '8082:8082'
    dependsOn:
      - service: srvthreds-bootstrap
        condition: service_completed_successfully

  srvthreds-session-agent:
    image: app
    profiles: [app]
    deploy: [minikube, dev, test, prod]
    containerName: srvthreds-session-agent
    restart: unless-stopped
    networks: [srvthreds-net]
    entrypoint: [node]
    command: [dist-server/src/ts/agent/agent.js, '-c', session_agent, '-i', org.wt.session1, '-d']
    environment:
      NODE_ENV: development
      MONGO_HOST: ${MONGO_HOST:-mongo-repl-1:27017}
      REDIS_HOST: ${REDIS_HOST:-redis:6379}
      RABBITMQ_HOST: ${RABBITMQ_HOST:-rabbitmq}
    ports:
      - '3000:3000'
      - '3001:3001'
    dependsOn:
      - service: srvthreds-bootstrap
        condition: service_completed_successfully

  srvthreds-persistence-agent:
    image: app
    profiles: [app]
    deploy: [minikube, dev, test, prod]
    containerName: srvthreds-persistence-agent
    restart: unless-stopped
    networks: [srvthreds-net]
    entrypoint: [node]
    command: [dist-server/src/ts/agent/agent.js, '-c', persistence_agent, '-i', org.wt.persistence1, '-d']
    environment:
      NODE_ENV: development
      MONGO_HOST: ${MONGO_HOST:-mongo-repl-1:27017}
      REDIS_HOST: ${REDIS_HOST:-redis:6379}
      RABBITMQ_HOST: ${RABBITMQ_HOST:-rabbitmq}
    dependsOn:
      - service: srvthreds-bootstrap
        condition: service_completed_successfully

# Profile groupings
# Used with --profile flag: npm run minikube -p srvthreds --profile infra
profiles:
  all: [infra, build, app]   # Everything (default) - build must come before app
  infra: [mongo-repl-1, redis]
  build: [srvthreds-builder]
  app: [srvthreds-bootstrap, srvthreds-engine, srvthreds-session-agent, srvthreds-persistence-agent]

# Hooks run after a profile's services are up
# These run BEFORE the next profile starts (critical for initialization order)
profileHooks:
  infra:
    postUp:
      - description: Initialize MongoDB replica set
        script: scripts/setup-repl.sh
        args: [srvthreds-mongo-repl-1]

# Network definitions
networks:
  srvthreds-net:
    driver: bridge
    name: srvthreds-net

# Environment-specific configuration
environments:
  minikube:
    registry: local
    ingressClass: nginx
    namespace: srvthreds
  dev:
    registry: cazsrvthredsdeacr.azurecr.io
    ingressClass: azure-application-gateway
    namespace: srvthreds
  test:
    registry: cazsrvthredsteacr.azurecr.io
    ingressClass: azure-application-gateway
    namespace: srvthreds
  prod:
    registry: cazsrvthredspacr.azurecr.io
    ingressClass: azure-application-gateway
    namespace: srvthreds

# Azure naming convention (for reference)
azure:
  prefix: CAZ
  appCode: SRVTHREDS
  regionCode: E

# Terraform paths (independent deployment)
terraform:
  stacksPath: terraform/stacks
  configPath: terraform
